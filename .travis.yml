version: ~> 1.0
os: linux
dist: bionic

language: ruby
cache: bundler
rvm:
- 2.7

jobs:
  include:
    - stage: test
      name: "Tests"
      script:
        - cp config/database.example.yml config/database.yml
        - bundle exec rake db:setup RAILS_ENV=test
        - bundle exec rails spec
    - name: "Audit"
        - bundle exec bundle-audit check --update
        - bundle exec brakeman -z

    - stage: deploy
      script: skip
      deploy:
        - provider: script
          script: .cicd/travis_deploy.sh
          on:
            branch: master
